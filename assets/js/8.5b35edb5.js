(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{592:function(t,s,a){t.exports=a.p+"assets/img/20220506144951.ef772b30.png"},593:function(t,s,a){t.exports=a.p+"assets/img/20220506145140.3afd66d9.png"},594:function(t,s,a){t.exports=a.p+"assets/img/20220506151446.603bc2c4.png"},595:function(t,s,a){t.exports=a.p+"assets/img/20220506151225.a34cddd3.png"},596:function(t,s,a){t.exports=a.p+"assets/img/20220506085354.47cbe9bd.png"},597:function(t,s,a){t.exports=a.p+"assets/img/20220506111609.e2837d4a.png"},598:function(t,s,a){t.exports=a.p+"assets/img/20220506111716.a5b9e75b.png"},610:function(t,s,a){"use strict";a.r(s);var n=a(17),r=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("blockquote",[n("p",[t._v("harbor镜像 从源harbor同步到各k8s环境环境，其中harbor的部署形式均为docker-compose")])]),t._v(" "),n("p",[t._v("该文档用于说明源harbor同步镜像到各环境harbor的部署以及使用方法。主要采用的模块为harbor自带的replication功能，该replication功能需要指定目标仓库，源项目，过滤registry，tag等，其触发方式为手动或者事件驱动，事件驱动设置为当符合replication规则的镜像被push到源harbor仓库时，会自动触发该replication。"),n("em",[n("strong",[t._v("难点在于，一主多从的harbor仓库配置以及网络隔离，这里采用的方案为本地启用nginx正向代理，对应环境的harbor设置专属虚拟域名，从而实现转发。")])])]),t._v(" "),n("h1",{attrs:{id:"源harbor配置项"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#源harbor配置项"}},[t._v("#")]),t._v(" 源harbor配置项")]),t._v(" "),n("ol",[n("li",[t._v("容器内部添加域名解析\n"),n("ul",[n("li",[n("p",[t._v("配置项:")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose.yaml")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 主要添加配置项为extra_hosts")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 其中core,registry,portal,proxy,chartmuseum等服务均需要添加该hosts")]),t._v("\n     "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("registry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" goharbor/registry"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("photon"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v2.0.3\n       "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" registry\n       "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n       "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cap_drop")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ALL\n       "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cap_add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" CHOWN\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" SETGID\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" SETUID\n       "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("extra_hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"zq.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fs.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"yf.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hz.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"st.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"yj.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mm.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"zh.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dg.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"qy.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cz.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hy.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sw.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"gz.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sg.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mz.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"jy.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"zj.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"py.harbor.com:xxx.xx.xx.xxx"')]),t._v("\n")])])])]),t._v(" "),n("li",[n("p",[t._v("重启harbor: docker-compose up -d")])])])]),t._v(" "),n("li",[t._v("harbor web端添加配置\n"),n("ul",[n("li",[t._v("添加目标仓库地址\n"),n("img",{attrs:{src:a(592),alt:"2"}})]),t._v(" "),n("li",[t._v("添加replication规则\n"),n("img",{attrs:{src:a(593),alt:"1"}})])])])]),t._v(" "),n("h1",{attrs:{id:"代理层配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#代理层配置"}},[t._v("#")]),t._v(" 代理层配置")]),t._v(" "),n("ol",[n("li",[n("p",[t._v("采用代理层的原因：\n每个环境的harbor仓库域名均为harbor.domain.com，在登录过程中会出现问题，其中harbor登录报文如下：\n"),n("img",{attrs:{src:a(594),alt:"3"}}),t._v("\n请求过程如下：\n"),n("img",{attrs:{src:a(595),alt:"4"}})]),t._v(" "),n("p",[t._v("由于各个环境的harbor域名均为harbor.domain.com，那么在第三次发起请求时，客户端会按照第二次请求返回的响应头的Www-Authenticate里的值进行该次请求，那么该次请求的url会是***http://harbor.domain.com:5002/service/token***，那么客户端在第三次请求的时候就无法将请求发送到正确的目标服务端。"),n("em",[n("strong",[t._v("解决方案为，在源harbor和目标harbor中添加一层正向代理，且在当响应码状态为401的时候，修改响应头里的\tWww-Authenticate的值，将harbor.domain.com:5002修改为对应环境的虚拟域名，该代理组件采用openresty")])]),t._v("。")])]),t._v(" "),n("li",[n("p",[t._v("openresty配置")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("nginx配置：")]),t._v(" "),n("div",{staticClass:"language-nginx extra-class"},[n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("upstream")]),t._v(" qy_harbor")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" xx.xxx.xxx.xx:5002 max_fails=3 fail_timeout=10s")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n      "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("keepalive")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("keepalive_requests")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("keepalive_timeout")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("45s")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("      \n  "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("89")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("       [::]:89")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("  qy.harbor.com")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v("         /usr/share/nginx/html")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$city")]),t._v(" qy")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n      "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_http_version")]),t._v(" 1.1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" Connection "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" X-Real-IP "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" X-Forwarded-For "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$proxy_add_x_forwarded_for")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n  \n          "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_connect_timeout")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("600")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_read_timeout")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("600")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_send_timeout")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("600")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("header_filter_by_lua_file")]),t._v(" lua/changRespHeader.lua")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token directive"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" http://qy_harbor/")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),n("li",[n("p",[t._v("lua脚本:")]),t._v(" "),n("div",{staticClass:"language-lua extra-class"},[n("pre",{pre:!0,attrs:{class:"language-lua"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" ngx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("401")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" respheader "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ngx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("resp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_headers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("pairs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("respheader"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" k "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"www-authenticate"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n              "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" newstr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ngx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("re"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sub")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"harbor.domain.com:5002/"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ngx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("var"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("city "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('".harbor.com:89/"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n              ngx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ngx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("INFO"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newstr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n              ngx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("header"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"www-authenticate"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" newstr\n          "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])])])])])])]),t._v(" "),n("h1",{attrs:{id:"问题跟踪"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#问题跟踪"}},[t._v("#")]),t._v(" 问题跟踪")]),t._v(" "),n("p",[n("strong",[t._v("问题描述")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[t._v("在通过harbor replication的过程中，有两个环境一直复制失败，harbor的任务日志中提示502 bad gateway。\n")])])]),n("p",[n("strong",[t._v("链路分析")]),t._v(" "),n("img",{attrs:{src:a(596),alt:"5"}})]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[t._v("查看其中一个环境harbor中各个组件的日志发现，core组件在接收客户端的put请求时，返回502；查看registry日志，显示在put请求过程中客户端断开连接。\n")])])]),n("p",[n("strong",[t._v("对比测试")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[t._v("将其harbor加入docker client的insecure docker registry分组中，直接在客户端本地通过docker push 命令行推送镜像到openresty代理的其harbor中，可推送成功；推测在harbor replication 过程中是客户端未及时收到服务端的响应，从而导致客户端主动断开连接\n")])])]),n("p",[n("strong",[t._v("报文跟踪")])]),t._v(" "),n("ol",[n("li",[n("p",[t._v("同时在源机器和目标机器上抓包")]),t._v(" "),n("ul",[n("li",[t._v("源机器报文\n"),n("img",{attrs:{src:a(597),alt:"6"}})]),t._v(" "),n("li",[t._v("目标机器报文\n"),n("img",{attrs:{src:a(598),alt:"7"}})])])]),t._v(" "),n("li",[n("p",[t._v("报文分析")]),t._v(" "),n("p",[t._v("从报文tcp流可知，在源端发送put请求的过程中，发生了连接重置（rst报文）；源机器显示是服务端主动发出rst报文，目标机器上显示是客户端主动发出rst报文。而两端报文的发起端的端口不同，一个是46220，一个是47399，推断在源机器和目标机器中间仍有代理环节，是由该代理层主动发出rst报文给服务端，服务端响应rst报文并最终反馈给客户端，导致在源机器上看到的是服务端主动发出的rst报文。")])])])])}),[],!1,null,null,null);s.default=r.exports}}]);